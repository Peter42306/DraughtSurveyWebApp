@model DraughtSurveyWebApp.ViewModels.DraughtsInputViewModel

@{
    ViewData["Title"] = "Edit Draught";
}

<form asp-action="Edit">

    <div class="row">
        <div class="col-6">
            <h4>Edit Draughts</h4>
        </div>
        <div class="col-6 text-end">
            <button type="submit" class="btn btn-primary me-2">Save</button>
            <a asp-controller="Inspections" asp-action="Details" asp-route-id="@Model.InspectionId" class="btn btn-secondary">Cancel</a>
        </div>
    </div>
    @* <hr /> *@

    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
    <input type="hidden" asp-for="InspectionId" />    
    <input type="hidden" asp-for="DraughtSurveyBlockId" />

    @if (Model.Inspection != null && !Model.Inspection.notShowInputWarnings && Model.VesselInput == null)
    {
        <div class="alert alert-warning">
            Vessel information is not filled in. Autofilling and calculations may be limited.
        </div>
    }

    

    


    <div class="row">
        <div class="col-lg-6">
            <hr />
            <h6>@(Model.SurveyType == SurveyType.Initial ? "Initial Apparent Draughts" : "Final Apparent Draughts")</h6>            
            <hr />

            

            <div class="row mb-2">
                <div class="col-4">
                    <label asp-for="DraughtFwdPS" class="control-label small-label"></label>
                    <input asp-for="DraughtFwdPS" class="form-control" type="number" step="0.01" />
                    <span asp-validation-for="DraughtFwdPS" class="text-danger"></span>
                </div>
                <div class="col-4">
                    <label asp-for="DraughtFwdSS" class="control-label small-label"></label>
                    <input asp-for="DraughtFwdSS" class="form-control" type="number" step="0.01" />
                    <span asp-validation-for="DraughtFwdSS" class="text-danger"></span>
                </div>
                <div class="col-4">
                    <label asp-for="DraughtMeanFwd" class="small-label"></label>
                    <input id="fwdMean" class="form-control bg-light" value="@Model.DraughtMeanFwd?.ToString("0.000")" readonly />
                </div>
            </div>

            <div class="row mb-2">
                <div class="col-4">
                    <label asp-for="DraughtMidPS" class="control-label small-label"></label>
                    <input asp-for="DraughtMidPS" class="form-control" type="number" step="0.01" />
                    <span asp-validation-for="DraughtMidPS" class="text-danger"></span>
                </div>
                <div class="col-4">
                    <label asp-for="DraughtMidSS" class="control-label small-label"></label>
                    <input asp-for="DraughtMidSS" class="form-control" type="number" step="0.01" />
                    <span asp-validation-for="DraughtMidSS" class="text-danger"></span>
                </div>
                <div class="col-4">
                    <label asp-for="DraughtMeanMid" class="small-label"></label>
                    <input id="midMean" class="form-control bg-light" value="@Model.DraughtMeanMid?.ToString("0.000")" readonly />
                </div>
            </div>

            <div class="row mb-2">
                <div class="col-4">
                    <label asp-for="DraughtAftPS" class="control-label small-label"></label>
                    <input asp-for="DraughtAftPS" class="form-control" type="number" step="0.01" />
                    <span asp-validation-for="DraughtAftPS" class="text-danger"></span>
                </div>
                <div class="col-4">
                    <label asp-for="DraughtAftSS" class="control-label small-label"></label>
                    <input asp-for="DraughtAftSS" class="form-control" type="number" step="0.01" />
                    <span asp-validation-for="DraughtAftSS" class="text-danger"></span>
                </div>
                <div class="col-4">
                    <label asp-for="DraughtMeanAft" class="small-label"></label>
                    <input id="aftMean" class="form-control bg-light" value="@Model.DraughtMeanAft?.ToString("0.000")" readonly />
                </div>
            </div>

            <hr />


            @if (Model.VesselInput != null && 
            Model.Inspection != null && !Model.Inspection.notShowInputWarnings &&
            (Model.DraughtMidPS.HasValue && Model.DraughtMidSS.HasValue) && !Model.VesselInput.BM.HasValue)
            {
                <div class="alert alert-warning">
                    Enter missing data (BM).
                </div>
            }



            <div class="row mb-2">
                <div class="col-8">
                    <label asp-for="Heel" class="small-label">
                        @(Model.HoggingSagging == null ? "Heel" : (Model.DraughtMidPS - Model.DraughtMidSS) < 0 ? "Heel to SS" : "Heel to PS")
                    </label>
                    <input class="form-control bg-light" value="@Model.Heel?.ToString("0.000")" readonly />
                </div>
                <div class="col-4">
                    <label asp-for="TrimApparent" class="small-label"></label>
                    <input class="form-control bg-light" value="@Model.TrimApparent?.ToString("0.000")" readonly />
                </div>
            </div>

            @if (Model.Inspection != null &&
                !Model.Inspection.notShowInputWarnings &&
                Model.SeaWaterDensity.HasValue && !Model.Swell.HasValue)
            {
                <div class="row mb-2">
                    <div class="col-12">
                        <div class="alert alert-warning">
                            Please enter Swell.                            
                        </div>
                    </div>
                </div>
            }



            <div class="row mb-2">
                <div class="col-8">

                    <!-- CHECKING SEA SIDE DRAUGHTS -->
                    <details>

                        <summary class="h6 mb-2 mt-3">
                            Sea Side Draughts Calculator
                        </summary>

                        <div class="row mb-2">
                            <div class="col-4">
                                <label for="draught-forward-ps" class="control-label small-label">Forward PS</label>
                                <input id="draught-forward-ps" class="form-control" type="number" step="0.01" />
                            </div>
                            <div class="col-4">
                                <label asp-for="BreadthForward" for="breadth-forward" class="control-label small-label">Breadth</label>
                                <input asp-for="BreadthForward" id="breadth-forward" class="form-control" type="number" step="0.01" />
                                <span asp-validation-for="BreadthForward" class="text-danger"></span>
                            </div>
                            <div class="col-4">
                                <label for="draught-forward-ss" class="control-label small-label">Forward SS</label>
                                <input id="draught-forward-ss" class="form-control" type="number" step="0.01" />
                            </div>
                        </div>                       

                        <div class="row mb-2">
                            <div class="col-4">
                                <label for="draught-mid-ps" class="control-label small-label">Midship PS</label>
                                <input id="draught-mid-ps" class="form-control bg-light" value="@Model.DraughtMidPS?.ToString()" readonly />
                            </div>
                            <div class="col-4">
                                <label for="breadth-moulded" class="control-label small-label">BM</label>
                                <input id="breadth-moulded" class="form-control bg-light" value="@Model.VesselInput?.BM?.ToString()" readonly />
                            </div>
                            <div class="col-4">
                                <label for="draught-mid-ss" class="control-label small-label">Midship SS</label>
                                <input id="draught-mid-ss" class="form-control bg-light" value="@Model.DraughtMidSS?.ToString()" readonly />
                            </div>
                        </div>

                        <div class="row mb-2">
                            <div class="col-4">
                                <label for="draught-aft-ps" class="control-label small-label">Aft PS</label>
                                <input id="draught-aft-ps" class="form-control" type="number" step="0.01" />
                            </div>
                            <div class="col-4">
                                <label asp-for="BreadthAft" for="breadth-aft" class="control-label small-label">Breadth</label>
                                <input asp-for="BreadthAft" id="breadth-aft" class="form-control" type="number" step="0.01" />
                                <span asp-validation-for="BreadthAft" class="text-danger"></span>
                            </div>
                            <div class="col-4">
                                <label for="draught-aft-ss" class="control-label small-label">Aft SS</label>
                                <input id="draught-aft-ss" class="form-control" type="number" step="0.01" />
                            </div>
                        </div>

                        <div class="row mb-2">
                            <div class="col-8">
                                <button type="button" onclick="calculateSeaDraughts()" class="btn btn-outline-primary w-100 mt-2">Calculate</button>
                            </div>
                            <div class="col-4">
                                <button type="button" onclick="clearInputDraughts()" class="btn btn-outline-danger w-100 mt-2">Clear</button>
                            </div>                            
                        </div>

                        <p class="control-label small-label">
                            Note: Sea side draught readings should always be taken visually, as per good marine practice. This calculator is for estimation purposes only.
                        </p>

                    </details>
                </div>

                <!-- CHECKING SWELL -->
                <div class="col-4">
                    <label asp-for="Swell" class="control-label small-label"></label>
                    <input asp-for="Swell" class="form-control" type="number" step="0.1" />
                    <span asp-validation-for="Swell" class="text-danger"></span>
                </div>

            </div>           
            
            
        </div>

        <div class="col-lg-6">
            <hr />            
            <h6>@(Model.SurveyType == SurveyType.Initial ? "Initial Corrections" : "Final Corrections")</h6>            
            <hr />

            @if (Model.Inspection != null && !Model.Inspection.notShowInputWarnings &&
              Model.DraughtFwdPS.HasValue && Model.DraughtFwdSS.HasValue &&
              Model.DraughtMidPS.HasValue && Model.DraughtMidSS.HasValue &&
              Model.DraughtAftPS.HasValue && Model.DraughtAftSS.HasValue &&
              !Model.DistanceFwd.HasValue && !Model.DistanceMid.HasValue && !Model.DistanceAft.HasValue)
            {
                <div class="alert alert-warning">
                    Enter missing data (distances).
                </div>
            }

            @if (Model.Inspection != null && !Model.Inspection.notShowInputWarnings &&
                Model.VesselInput != null &&
                 Model.DraughtFwdPS.HasValue && Model.DraughtFwdSS.HasValue &&
                 Model.DraughtMidPS.HasValue && Model.DraughtMidSS.HasValue &&
                 Model.DraughtAftPS.HasValue && Model.DraughtAftSS.HasValue &&
                 Model.DistanceFwd.HasValue && Model.DistanceMid.HasValue && Model.DistanceAft.HasValue &&
                 !Model.VesselInput.LBP.HasValue)
            {
                <div class="alert alert-warning">
                    Enter missing data (LBP).
                </div>
            }

            @if (Model.Inspection != null && !Model.Inspection.notShowInputWarnings &&
                ViewData["DistancesSuggestionNote"] != null)
            {
                <div class="alert alert-info">
                    <strong>Note:</strong>
                    @Html.Raw(ViewData["DistancesSuggestionNote"])
                </div>
            }

            <div class="row mb-2">
                <div class="col-3">
                    <label asp-for="DistanceFwd" class="control-label small-label"></label>
                    <input asp-for="DistanceFwd" class="form-control" type="number" step="0.01" />
                    <span asp-validation-for="DistanceFwd" class="text-danger"></span>
                </div>
                <div class="col-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" asp-for="IsFwdDistancetoFwd" value="true" />
                        <label class="form-check-label small-label">to Fwd</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" asp-for="IsFwdDistancetoFwd" value="false" />
                        <label class="form-check-label small-label">to Aft</label>
                    </div>
                </div>
                <div class="col-3">
                    <label asp-for="DraughtCorrectionFwd" class="small-label"></label>
                    <input class="form-control bg-light" value="@Model.DraughtCorrectionFwd?.ToString("0.000")" readonly />
                </div>
                <div class="col-3">
                    <label asp-for="DraughtCorrectedFwd" class="small-label"></label>
                    <input class="form-control bg-light" value="@Model.DraughtCorrectedFwd?.ToString("0.000")" readonly />
                </div>
            </div>

            <div class="row mb-2">

                <div class="col-3">
                    <label asp-for="DistanceMid" class="control-label small-label"></label>
                    <input asp-for="DistanceMid" class="form-control" type="number" step="0.01" />
                    <span asp-validation-for="DistanceMid" class="text-danger"></span>
                </div>
                <div class="col-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" asp-for="IsMidDistanceToFwd" value="true" />
                        <label class="form-check-label small-label">to Fwd</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" asp-for="IsMidDistanceToFwd" value="false" />
                        <label class="form-check-label small-label">to Aft</label>
                    </div>
                </div>
                <div class="col-3">
                    <label asp-for="DraughtCorrectionMid" class="small-label"></label>
                    <input class="form-control bg-light" value="@Model.DraughtCorrectionMid?.ToString("0.000")" readonly />
                </div>
                <div class="col-3">
                    <label asp-for="DraughtCorrectedMid" class="small-label"></label>
                    <input class="form-control bg-light" value="@Model.DraughtCorrectedMid?.ToString("0.000")" readonly />
                </div>
            </div>

            <div class="row mb-2">
                <div class="col-3">
                    <label asp-for="DistanceAft" class="control-label small-label"></label>
                    <input asp-for="DistanceAft" class="form-control" type="number" step="0.01" />
                    <span asp-validation-for="DistanceAft" class="text-danger"></span>
                </div>
                <div class="col-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" asp-for="IsAftDistanceToFwd" value="true" />
                        <label class="form-check-label small-label">to Fwd</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" asp-for="IsAftDistanceToFwd" value="false" />
                        <label class="form-check-label small-label">to Aft</label>
                    </div>
                </div>
                <div class="col-3">
                    <label asp-for="DraughtCorrectionAft" class="small-label"></label>
                    <input class="form-control bg-light" value="@Model.DraughtCorrectionAft?.ToString("0.000")" readonly />
                </div>
                <div class="col-3">
                    <label asp-for="DraughtCorrectedAft" class="small-label"></label>
                    <input class="form-control bg-light" value="@Model.DraughtCorrectedAft?.ToString("0.000")" readonly />
                </div>
            </div>

            <hr />
            <div class="row mb-2">
                <div class="col-4">
                    <label asp-for="LBD" class="small-label"></label>
                    <input class="form-control bg-light" value="@Model.LBD?.ToString("0.000")" readonly />
                </div>
                <div class="col-4">
                    <label asp-for="HoggingSagging" class="small-label">
                        @(Model.HoggingSagging == null ? "Hog/Sag" : Model.HoggingSagging < 0 ? "Hogging" : "Sagging")
                    </label>
                    <input class="form-control bg-light" value="@Model.HoggingSagging?.ToString("0.000")" readonly />
                </div>
                <div class="col-4">
                    <label asp-for="TrimCorrected" class="small-label"></label>
                    <input class="form-control bg-light" value="@Model.TrimCorrected?.ToString("0.000")" readonly />
                </div>
            </div>

            <div class="row mb-2">
                <div class="col-6">
                </div>
                <div class="col-6">
                    <label asp-for="MeanAdjustedDraught" class="small-label"></label>
                    <input class="form-control bg-light" value="@Model.MeanAdjustedDraught?.ToString("0.000")" readonly />
                </div>
            </div>

            <hr />
            <div class="row mb-2">
                <div class="col-6">
                </div>
                <div class="col-6">
                    <label asp-for="KeelCorrection" class="control-label small-label"></label>
                    <input asp-for="KeelCorrection" class="form-control" type="number" step="0.001" />
                    <span asp-validation-for="KeelCorrection" class="text-danger"></span>
                </div>
            </div>
            
            @if (Model.Inspection != null &&
                !Model.Inspection.notShowInputWarnings &&
                Model.MeanAdjustedDraught.HasValue &&
                !Model.SeaWaterDensity.HasValue)
            {
                <div class="alert alert-warning">
                    Enter missing data (sea water density)
                </div>
            }

            <div class="row mb-2">
                

                <div class="col-6">
                </div>
                <div class="col-6">
                    <label asp-for="SeaWaterDensity" class="control-label small-label"></label>
                    <input asp-for="SeaWaterDensity" class="form-control" type="number" step="0.0005" />
                    <span asp-validation-for="SeaWaterDensity" class="text-danger"></span>
                </div>
            </div>
        </div>
    </div>



</form>


@* <div>
    <a asp-controller="Inspections" asp-action="Details" asp-route-id="@Model.InspectionId">Back</a>
</div> *@

@* @section Scripts {
    <script>

        function calculateApparentMeam(){
            const fwdPS = parseFloat(document.getElementById("DraughtFwdPS").value) || 0;
            const fwdSS = parseFloat(document.getElementById("DraughtFwdSS").value) || 0;
            const midPS = parseFloat(document.getElementById("DraughtMidPS").value) || 0;
            const midSS = parseFloat(document.getElementById("DraughtMidSS").value) || 0;
            const aftPS = parseFloat(document.getElementById("DraughtAftPS").value) || 0;
            const aftSS = parseFloat(document.getElementById("DraughtAftSS").value) || 0;

            const fwdMean = ((fwdPS + fwdSS)/2).toFixed(3);
            const midMean = ((midPS + midSS)/2).toFixed(3);
            const aftMean = ((aftPS + aftSS)/2).toFixed(3);

            document.getElementById("fwdMean").value = fwdMean;
            document.getElementById("midMean").value = midMean;
            document.getElementById("aftMean").value = aftMean;
        }

        document.addEventListener("DOMContentLoaded", function() {

            const fields = [
                "DraughtFwdPS", "DraughtFwdSS",
                "DraughtMidPS", "DraughtMidSS",
                "DraughtAftPS", "DraughtAftSS"
            ];

            fields.forEach(id => {
                const input = document.getElementById(id);

                if(input){
                    input.addEventListener("input", calculateApparentMeam);
                }
            });

            calculateApparentMeam();
        });

    </script>
}
 *@


<script>
    function calculateSeaDraughts(){
        const allFilled = [
            "draught-forward-ps", 
            "draught-forward-ss", 
            "draught-aft-ps", 
            "draught-aft-ss"
        ].every(id => {
            const el =document.getElementById(id);
                return el && el.value.trim() !== "";
            });

            if(allFilled){
                alert("All draught readings are filled. Please clear cells before the next sea side draught recalculation.");
                return;
            }

        const draughtMidPS = parseFloatOrNull("draught-mid-ps");
        const draughtMidSS = parseFloatOrNull("draught-mid-ss");
        const breadthMoulded = parseFloatOrNull("breadth-moulded");

        if(draughtMidPS === null || draughtMidSS === null || breadthMoulded === null || breadthMoulded === 0) {
            return;
        }

        const correctionRatioAtMidship = (draughtMidPS - draughtMidSS) / breadthMoulded;

        // Forward
        const draughtForwardPS = parseFloatOrNull("draught-forward-ps");
        const draughtForwardSS = parseFloatOrNull("draught-forward-ss");
        const breadthForward = parseFloatOrNull("breadth-forward");

        if(breadthForward !== null){
            if(draughtForwardPS !== null && draughtForwardSS === null){
                setValue("draught-forward-ss", draughtForwardPS - correctionRatioAtMidship * breadthForward);
            } 
            else if(draughtForwardPS === null && draughtForwardSS !== null){
                setValue("draught-forward-ps", draughtForwardSS + correctionRatioAtMidship * breadthForward);
            }
        }

        // Aft
        const draughtAftPS = parseFloatOrNull("draught-aft-ps");
        const draughtAftSS = parseFloatOrNull("draught-aft-ss");
        const breadthAft = parseFloatOrNull("breadth-aft");

        if(breadthAft !== null){
            if(draughtAftPS !== null && draughtAftSS === null){
                setValue("draught-aft-ss", draughtAftPS - correctionRatioAtMidship * breadthAft);
            }
            else if(draughtAftPS === null && draughtAftSS !== null){
                setValue("draught-aft-ps", draughtAftSS + correctionRatioAtMidship * breadthAft);
            }
        }
    }

    function clearInputDraughts(){
        const idsToClear = [
            "draught-forward-ps", "draught-forward-ss",
            "draught-aft-ps", "draught-aft-ss"
        ];

        idsToClear.forEach(id => {
            const idToClear = document.getElementById(id);
            if(idToClear !== null && idToClear !== undefined){
                idToClear.value = "";
            }
        });
    }

    function parseFloatOrNull(id){
        const element = document.getElementById(id);
        if(!element){
            return null;
        }
        
        const value = element.value.trim().replace(",",".");
        const parsed = parseFloat(value);
        return isNaN(parsed) ? null : parsed;
    }

    function setValue(id, value){
        const element = document.getElementById(id);
        if(element !== null){
            element.value = value.toFixed(3);
        }
    }
</script>